jobs:
- job: linux
  pool: {vmImage: 'Ubuntu-20.04'}
  variables:
    CIBW_BEFORE_ALL: "./build_mlpack.sh"
    MLPACK_VERSION: 4.0.0
  steps:
    - task: UsePythonVersion@0
    - bash: |
        set -o errexit
        python3 -m pip install --upgrade pip
        pip3 install cibuildwheel
        sudo apt-get update
        sudo apt-get install libarmadillo-dev libcereal-dev g++ cmake libensmallen-dev
      displayName: Install dependencies

    - bash: |
        git clone https://github.com/mlpack/mlpack
        cd mlpack
        git checkout $(MLPACK_VERSION)
        mkdir build
        cd build
        cmake -DBUILD_PYTHON_BINDINGS=ON ../
        make -j2 python
        cd src/mlpack/bindings/python/mlpack/
        ls
      displayName: Clone mlpack

    - bash: |
        CIBW_BEFORE_ALL="./build_mlpack.sh" cibuildwheel --output-dir wheelhouse .
      displayName: Build wheels

    - task: PublishBuildArtifacts@1
      inputs: {pathtoPublish: 'wheelhouse'}
