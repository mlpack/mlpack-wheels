jobs:
- job: linux
  timeoutInMinutes: 0 # No limit for build time.
  pool: {vmImage: 'Ubuntu-20.04'}
  variables:
    MLPACK_VERSION: 4.0.0
    CIBW_BUILD: cp36-manylinux_x86_64
    CIBW_TEST_COMMAND: python -c 'import mlpack; import numpy as np; x = np.random.rand(100, 10); o = mlpack.pca(input_=x, new_dimensionality=5, verbose=True)'
  steps:
    - task: UsePythonVersion@0
    - bash: |
        set -o errexit
        python3 -m pip install --upgrade pip
        pip3 install cibuildwheel cython numpy pandas setuptools
        sudo apt-get update
        sudo apt-get install libarmadillo-dev libcereal-dev g++ cmake libensmallen-dev
      displayName: Install dependencies

    - bash: |
        git clone https://github.com/mlpack/mlpack
        cd mlpack
        git checkout $(MLPACK_VERSION)
      displayName: Clone mlpack

    - bash: |
        mkdir -p mlpack/build
        cd mlpack/build
        cmake -DBUILD_PYTHON_BINDINGS=ON ../
        make python_configured
      displayName: Generate setup.py

    - bash: |
        export CIBW_BEFORE_BUILD="pwd && ls && ./build_mlpack.sh"
        cibuildwheel --output-dir wheelhouse mlpack/build/src/mlpack/bindings/python/
      displayName: Build wheels

    - task: PublishBuildArtifacts@1
      inputs: {pathtoPublish: 'wheelhouse'}
