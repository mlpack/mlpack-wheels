From 3b372c585610747cbd0b4a41e00d2a9794444d11 Mon Sep 17 00:00:00 2001
From: Ryan Curtin <ryan@ratml.org>
Date: Wed, 9 Nov 2022 12:51:41 -0500
Subject: [PATCH] Use -framework Accelerate on OS X.

---
 CMake/FindArmadillo.cmake | 34 +++++++++++++++++++++++++++-------
 1 file changed, 27 insertions(+), 7 deletions(-)

diff --git a/CMake/FindArmadillo.cmake b/CMake/FindArmadillo.cmake
index 3d696b0abb..8c5e0260ca 100644
--- a/CMake/FindArmadillo.cmake
+++ b/CMake/FindArmadillo.cmake
@@ -81,23 +81,43 @@ endif()
 # Link to support libraries in either case on MSVC.
 if(NOT _ARMA_USE_WRAPPER OR MSVC)
   if(_ARMA_USE_LAPACK)
-    if(ARMADILLO_FIND_QUIETLY OR NOT ARMADILLO_FIND_REQUIRED)
-      find_package(LAPACK QUIET)
+    if(APPLE)
+      # Use -framework Accelerate to link against the Accelerate framework on
+      # MacOS; ignore OpenBLAS or other variants.
+      set(LAPACK_LIBRARIES "-framework Accelerate")
+      set(LAPACK_FOUND YES)
     else()
-      find_package(LAPACK REQUIRED)
+      if(ARMADILLO_FIND_QUIETLY OR NOT ARMADILLO_FIND_REQUIRED)
+        find_package(LAPACK QUIET)
+      else()
+        find_package(LAPACK REQUIRED)
+      endif()
     endif()
+
     if(LAPACK_FOUND)
       set(_ARMA_SUPPORT_LIBRARIES "${_ARMA_SUPPORT_LIBRARIES}" "${LAPACK_LIBRARIES}")
     endif()
   endif()
   if(_ARMA_USE_BLAS)
-    if(ARMADILLO_FIND_QUIETLY OR NOT ARMADILLO_FIND_REQUIRED)
-      find_package(BLAS QUIET)
+    if(APPLE)
+      # Use -framework Accelerate to link against the Accelerate framework on
+      # MacOS; ignore OpenBLAS or other variants.
+      set(BLAS_LIBRARIES "-framework Accelerate")
+      set(BLAS_FOUND YES)
     else()
-      find_package(BLAS REQUIRED)
+      if(ARMADILLO_FIND_QUIETLY OR NOT ARMADILLO_FIND_REQUIRED)
+        find_package(BLAS QUIET)
+      else()
+        find_package(BLAS REQUIRED)
+      endif()
     endif()
+
     if(BLAS_FOUND)
-      set(_ARMA_SUPPORT_LIBRARIES "${_ARMA_SUPPORT_LIBRARIES}" "${BLAS_LIBRARIES}")
+      # Avoid doubly linking (not that it makes much difference other than a
+      # nicer command-line).
+      if (NOT BLAS_LIBRARIES EQUAL LAPACK_LIBRARIES)
+        set(_ARMA_SUPPORT_LIBRARIES "${_ARMA_SUPPORT_LIBRARIES}" "${BLAS_LIBRARIES}")
+      endif ()
     endif()
   endif()
   if(_ARMA_USE_ARPACK)
-- 
2.38.1

